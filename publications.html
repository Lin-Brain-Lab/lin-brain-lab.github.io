<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Publications | Lin Brain Lab</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 40px auto;
      line-height: 1.6;
      color: #222;
    }
    h1 {
      color: #004080;
      margin-bottom: 0.5em;
    }
    nav a {
      margin-right: 12px;
      color: #004080;
      text-decoration: none;
    }
    nav a:hover {
      text-decoration: underline;
    }
    .year {
      font-size: 1.3em;
      color: #004080;
      margin-top: 2em;
      border-bottom: 1px solid #ccc;
      padding-bottom: 4px;
    }
    .paper {
      margin-bottom: 1em;
    }
    .loading {
      color: gray;
    }
    footer {
      margin-top: 3em;
      font-size: 0.9em;
      color: #666;
      text-align: center;
      border-top: 1px solid #ccc;
      padding-top: 1em;
    }
  </style>
</head>

<body>
  <nav>
    <a href="index.html">Home</a>
    <a href="research.html">Research</a>
    <a href="publications.html">Publications</a>
    <a href="tools-data.html">Tools/Data</a>
    <a href="members.html">Members</a>
  </nav>
  <hr>

  <h1>Publications</h1>
  <div id="status" class="loading">Loading publications from PubMed...</div>
  <div id="publications"></div>

  <footer>
    © <script>document.write(new Date().getFullYear())</script> Lin Brain Lab — All Rights Reserved
  </footer>

  <script>
  async function loadPublications() {
    const author = "Fa-Hsuan Lin[Author]";
    const API_KEY = "9882ae459c2ff1bb4395a27962b698c02b08"; // ← OPTIONAL: insert your NCBI API key here
    const cors = "https://corsproxy.io/?";
    const base = "https://eutils.ncbi.nlm.nih.gov/entrez/eutils/";

    const cached = localStorage.getItem("pubmed_cache");
    if (cached) {
      document.getElementById("status").remove();
      document.getElementById("publications").innerHTML = cached;
      console.log("Loaded publications from local cache.");
      return;
    }

    try {
      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), 15000);

      // Step 1: Search PubMed
      const searchUrl = `${cors}${encodeURIComponent(
        base + "esearch.fcgi?db=pubmed&term=" +
        encodeURIComponent(author) +
        "&retmax=200&sort=pub+date&retmode=json" +
        (API_KEY ? "&api_key=" + API_KEY : "")
      )}`;
      const searchResponse = await fetch(searchUrl, { signal: controller.signal });
      const searchText = await searchResponse.text();
      clearTimeout(timeout);
      const searchData = JSON.parse(searchText);
      const ids = searchData.esearchresult?.idlist || [];

      if (!ids.length) {
        document.getElementById("status").innerText = "No publications found.";
        return;
      }

      // Step 2: Get summaries
      const summaryUrl = `${cors}${encodeURIComponent(
        base + "esummary.fcgi?db=pubmed&id=" +
        ids.join(",") +
        "&retmode=json" +
        (API_KEY ? "&api_key=" + API_KEY : "")
      )}`;
      const summaryResponse = await fetch(summaryUrl);
      const summaryText = await summaryResponse.text();
      const summaryData = JSON.parse(summaryText);

      const papers = Object.values(summaryData.result)
        .filter(p => p.uid)
        .map(p => ({
          title: p.title,
          source: p.fulljournalname,
          year: p.pubdate.match(/\d{4}/)?.[0] || "No Year",
          authors: p.authors?.map(a => a.name).join(", ") || "",
          pmid: p.uid
        }));

      // Step 3: Sort & group
      papers.sort((a, b) => (b.year || 0) - (a.year || 0));
      const grouped = papers.reduce((acc, p) => {
        acc[p.year] = acc[p.year] || [];
        acc[p.year].push(p);
        return acc;
      }, {});

      // Step 4: Render
      const container = document.getElementById("publications");
      document.getElementById("status").remove();

      let html = "";
      for (const year of Object.keys(grouped).sort((a, b) => b - a)) {
        html += `<div class="year">${year}</div>`;
        grouped[year].forEach(p => {
          html += `
            <div class="paper">
              <strong>${p.title}</strong><br>
              <em>${p.source}</em><br>
              ${p.authors}<br>
              <a href="https://pubmed.ncbi.nlm.nih.gov/${p.pmid}/" target="_blank">PMID: ${p.pmid}</a>
            </div>
          `;
        });
      }
      container.innerHTML = html;
      localStorage.setItem("pubmed_cache", html);
      console.log("Publications saved to cache.");
    } catch (err) {
      console.error("PubMed fetch failed:", err);
      document.getElementById("status").innerText =
        "Error loading publications (check connection or proxy).";
    }
  }

  loadPublications();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Continuous Video Rating | Lin Brain Lab</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 40px;
      max-width: 700px;
      line-height: 1.6;
    }
    h2 { color: #007bff; }
    #player {
      width: 100%;
      max-width: 700px;
      height: 400px;
      border: none;
      margin-top: 15px;
    }
    input[type="range"] {
      width: 100%;
      margin-top: 25px;
      accent-color: #007bff;
    }
    .value-display {
      text-align: center;
      font-size: 18px;
      margin-top: 10px;
    }
    button {
      margin-top: 25px;
      padding: 10px 20px;
      font-size: 16px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    button:hover { background-color: #0056b3; }
    .message { margin-top: 15px; font-weight: bold; }
  </style>
  <script src="https://www.youtube.com/iframe_api"></script>
</head>

<body>
  <h2>üé¨ Continuous Video Rating</h2>
  <p>
    Watch the following YouTube clip and continuously move the slider between
    <strong>‚Äì1</strong> (very negative) and <strong>+1</strong> (very positive).
    Ratings start automatically after clip starts showing and record every five seconds. Ratings stop 
    automatically when the clip ends.
  </p>

  <!-- ‚ñ∂Ô∏è  YouTube player -->
  <div id="player"></div>

  <!-- Slider -->
  <div style="margin-top:25px;">
    <label for="rating">Your Rating (‚Äì1 to +1):</label>
    <input type="range" id="rating" min="-1" max="1" step="0.01" value="0">
    <div class="value-display">Current value: <span id="ratingValue">0</span></div>
  </div>

  // <button id="startBtn">‚ñ∂Ô∏è Start Recording</button>
  // <button id="stopBtn" disabled>‚èπ Stop Recording</button>
  <div class="message" id="message"></div>

  <script>
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyd7Ug5SOd1P_pjxGXetOubkNfAyBFRLcd3YpBSAxT_Hl1_zewmUPIavfgRROboFSmu/exec"; 
    const videoName = "YouTube Clip Example";
    const samplingInterval = 5;   // seconds
    const ratingSlider = document.getElementById('rating');
    const ratingValue = document.getElementById('ratingValue');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const message = document.getElementById('message');

    let player;
    let recording = false;
    let timer = null;
    let playTime = '';
    let ipAddress = '';

    // ===== YouTube Player API =====
    function onYouTubeIframeAPIReady() {
      player = new YT.Player('player', {
        height: '400',
        width: '700',
        videoId: 'sVGPbsBMK_4',   // üëà e.g. "dQw4w9WgXcQ"
        playerVars: { controls: 1, rel: 0, modestbranding: 1 },
        events: { 'onStateChange': onPlayerStateChange }
      });
    }

    function onPlayerStateChange(event) {
      if (event.data === YT.PlayerState.PLAYING && !recording) {
        playTime = new Date().toISOString();
        startRecording();
      }
      if (event.data === YT.PlayerState.ENDED && recording) {
        stopRecording();
      }
    }

    // ===== Rating controls =====
    ratingSlider.addEventListener('input', () => {
      ratingValue.textContent = ratingSlider.value;
    });


    function getIP() {
      return new Promise((resolve) => {
        const script = document.createElement('script');
        const callbackName = 'ipifyCallback_' + Math.random().toString(36).substring(2);
        window[callbackName] = function (data) {
          resolve(data.ip);
          delete window[callbackName];
          script.remove();
        };
        script.src = `https://api.ipify.org?format=jsonp&callback=${callbackName}`;
        script.onerror = () => resolve('unknown');
        document.body.appendChild(script);
      });
    }

    async function sendRating(rating, timestamp) {
      const payload = { videoName, playTime, rateTime: timestamp, rating, ip: ipAddress };
      try {
        await fetch(GOOGLE_SCRIPT_URL, {
          method: "POST",
          mode: "no-cors",            // üëà this is the key line
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
      } catch (err) { console.error("Error sending rating:", err); }
    }

    async function startRecording() {
      if (recording) return;
      ipAddress = await getIP();
      recording = true;
      message.style.color = 'green';
      message.textContent = `‚è∫ Recording started ‚Äì logging every ${samplingInterval}s`;
      startBtn.disabled = true;
      stopBtn.disabled = false;
      timer = setInterval(async () => {
        const now = new Date().toISOString();
        await sendRating(ratingSlider.value, now);
      }, samplingInterval * 1000);
    }

    function stopRecording() {
      if (!recording) return;
      clearInterval(timer);
      recording = false;
      message.style.color = 'blue';
      message.textContent = "‚úÖ Recording stopped.";
      startBtn.disabled = false;
      stopBtn.disabled = true;
    }

    // Buttons not needed anymore, but you can still show feedback
    startBtn.style.display = "none";
    stopBtn.style.display = "none";

    function onPlayerStateChange(event) {
      if (event.data === YT.PlayerState.PLAYING && !recording) {
        playTime = new Date().toISOString();
        startRecording();
      } else if (event.data === YT.PlayerState.ENDED && recording) {
        stopRecording();
      }
    }

  </script>
</body>
</html>



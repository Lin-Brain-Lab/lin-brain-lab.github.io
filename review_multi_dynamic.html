<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Continuous Video Rating | Lin Brain Lab</title>

  <style>
    body {
      font-family: sans-serif;
      margin: 40px;
      max-width: 700px;
      line-height: 1.6;
    }
    h2 { color: #007bff; }
    #player {
      width: 100%;
      max-width: 700px;
      height: 400px;
      border: none;
      margin-top: 15px;
    }
    input[type="range"] {
      width: 100%;
      margin-top: 25px;
      accent-color: #007bff;
    }
    .value-display {
      text-align: center;
      font-size: 18px;
      margin-top: 10px;
    }
    .message {
      margin-top: 15px;
      font-weight: bold;
    }
  </style>

  <script src="https://www.youtube.com/iframe_api"></script>
</head>

<body>
  <h2>ðŸŽ¬ Continuous Video Rating</h2>
  <p>
    Watch the YouTube clip below and move the slider between
    <strong>â€“1</strong> (very negative) and <strong>+1</strong> (very positive).
    Ratings are logged automatically every few seconds during playback.
  </p>

  <div id="player"></div>

  <!-- Slider -->
  <div style="margin-top:25px;">
    <label for="rating">Your Rating (â€“1 to +1):</label>
    <input type="range" id="rating" min="-1" max="1" step="0.01" value="0" />
    <div class="value-display">Current value: <span id="ratingValue">0</span></div>
  </div>

  <div class="message" id="message"></div>

  <script>
    // === Configuration ===
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyxdIgy5YbKeG6pSjMXxAepbV2NwDHD9ShBDgxqG0uR9g4vgraiKFhsXgzc-yOJNGYyYA/exec"; // your permanent web app URL
    const samplingInterval = 5; // seconds between logs

    // === Read URL parameters dynamically ===
    const urlParams = new URLSearchParams(window.location.search);
    const videoId = urlParams.get("videoId") || "sVGPbsBMK_4"; // default YouTube ID
    const sheetId = urlParams.get("sheetId") || null;          // target Sheet ID
    const videoName = `YouTube Video (${videoId})`;

    // === DOM references ===
    const ratingSlider = document.getElementById("rating");
    const ratingValue = document.getElementById("ratingValue");
    const message = document.getElementById("message");

    let player;
    let recording = false;
    let timer = null;
    let playTime = "";
    let ipAddress = "";

    // === Get viewer's IP (JSONP to avoid CORS) ===
    function getIP() {
      return new Promise((resolve) => {
        const script = document.createElement("script");
        const callbackName = "ipifyCallback_" + Math.random().toString(36).substring(2);
        window[callbackName] = function (data) {
          resolve(data.ip);
          delete window[callbackName];
          script.remove();
        };
        script.src = `https://api.ipify.org?format=jsonp&callback=${callbackName}`;
        script.onerror = () => resolve("unknown");
        document.body.appendChild(script);
      });
    }

    // === YouTube API Ready ===
    function onYouTubeIframeAPIReady() {
      player = new YT.Player("player", {
        height: "400",
        width: "700",
        videoId: videoId,
        playerVars: { controls: 1, rel: 0, modestbranding: 1 },
        events: { onStateChange: onPlayerStateChange },
      });
    }

    // === Player events ===
    function onPlayerStateChange(event) {
      if (event.data === YT.PlayerState.PLAYING && !recording) {
        playTime = new Date().toISOString();
        startRecording();
      } else if ((event.data === YT.PlayerState.ENDED || event.data === YT.PlayerState.PAUSED) && recording) {
        stopRecording();
      }
    }

    ratingSlider.addEventListener("input", () => {
      ratingValue.textContent = ratingSlider.value;
    });

    // === Send rating to Google Sheet ===
    async function sendRating(rating, timestamp) {
      const payload = {
        videoId,
        videoName,
        playTime,
        rateTime: timestamp,
        rating,
        ip: ipAddress,
        sheetId
      };
      try {
        await fetch(GOOGLE_SCRIPT_URL, {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
      } catch (err) {
        console.error("Error sending rating:", err);
      }
    }

    // === Recording control ===
    async function startRecording() {
      if (recording) return;
      ipAddress = await getIP();
      recording = true;
      message.style.color = "green";
      message.textContent = `âº Recording started â€“ logging every ${samplingInterval}s`;
      timer = setInterval(async () => {
        const now = new Date().toISOString();
        await sendRating(ratingSlider.value, now);
      }, samplingInterval * 1000);
    }

    function stopRecording() {
      if (!recording) return;
      clearInterval(timer);
      recording = false;
      message.style.color = "blue";
      message.textContent = "âœ… Recording stopped.";
    }
  </script>
</body>
</html>
